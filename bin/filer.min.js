var PwnFiler=PwnFiler||function(a){a=a||{};this.multiple=a.multiple||false;if(a.uploadButton){var b=a.uploadButton;if(!(b instanceof Element)){b=document.querySelector(b)}this.initControl(b)}if(a.dropArea){var d=a.dropArea;if(!(d instanceof Element)){d=document.querySelector(d)}this.initDropArea(d,a.dropAreaActiveClass||"active")}var e=null;if(a.commitButton){e=a.commitButton;if(!(e instanceof Element)){e=document.querySelector(e)}}else{if(this.multiple){throw"No commit button provided for multi-file uploader"}}if(a.selection){var c=a.selection;if(!(c instanceof Element)){c=document.querySelector(c)}this.initSelection(c,e)}else{throw"Missing file selection display"}};PwnFiler.prototype.initControl=function(a){var b=document.createElement("input");b.setAttribute("type","file");if(this.multiple){b.setAttribute("multiple","multiple")}var d=b.style;d.display="block";d.position="absolute";d.width=d.height="0";d.zIndex="-1000";a.parentNode.insertBefore(b,a);var c=this;a.addEventListener("click",function(e){return c.onUploadClick(e)},false);b.addEventListener("change",function(e){return c.onFileInputChange(e)},false);this.fileInput=b};PwnFiler.prototype.onUploadClick=function(a){this.fileInput.click();a.preventDefault();return false};PwnFiler.prototype.onFileInputChange=function(c){var d=c.target;if(d.files.length===0){this.onFileSelect(null)}else{var b=[];for(var a=0;a<d.files.length;a+=1){b[a]=d.files[a]}this.onFileSelect(b)}return true};PwnFiler.prototype.initDropArea=function(b,a){var c=this;b.addEventListener("dragenter",function(d){return c.onDropAreaDragEnter(d)},false);b.addEventListener("dragover",this.onDropAreaDragOver,false);b.addEventListener("dragleave",function(d){return c.onDropAreaDragLeave(d)},false);b.addEventListener("drop",function(d){return c.onDropAreaDrop(d)},false);this.dropArea=b;this.dropActiveClass=a;this.dropAreaEnterCount=0};PwnFiler.prototype.onDropAreaDragEnter=function(b){var a=b.dataTransfer;if(PwnFiler.dataTransferHasFiles(a)){a.dropEffect="copy"}else{return true}if(this.dropAreaEnterCount===0){this.activateDropArea()}this.dropAreaEnterCount+=1;b.stopPropagation();b.preventDefault();return false};PwnFiler.prototype.onDropAreaDragLeave=function(a){if(!PwnFiler.dataTransferHasFiles(a.dataTransfer)){return true}this.dropAreaEnterCount-=1;if(this.dropAreaEnterCount===0){this.deactivateDropArea()}};PwnFiler.prototype.dropAreaEnterCount=0;PwnFiler.prototype.onDropAreaDragOver=function(b){var a=b.dataTransfer;if(PwnFiler.dataTransferHasFiles(a)){a.dropEffect="copy"}else{return true}b.stopPropagation();b.preventDefault();return false};PwnFiler.prototype.onDropAreaDrop=function(d){this.dropAreaEnterCount=0;this.deactivateDropArea();var a=d.dataTransfer;if(a.files.length!==0){var c=[];for(var b=0;b<a.files.length;b+=1){c[b]=a.files.item(b)}this.onFileSelect(c);a.dropEffect="copy"}d.stopPropagation();d.preventDefault();return false};PwnFiler.prototype.activateDropArea=function(){var b=this.dropArea;var a=this.dropActiveClass;if(b.className.split(/\s+/).indexOf(a)===-1){b.className+=" "+a}};PwnFiler.prototype.deactivateDropArea=function(){var b=this.dropArea;var a=this.dropActiveClass;b.className=b.className.split(/\s+/).filter(function(c){return c!==a}).join(" ")};PwnFiler.dataTransferHasFiles=function(a){if(a.types.contains){return a.types.contains("Files")}else{if(a.types.indexOf){return a.types.indexOf("Files")!==-1}else{if(a.files){return a.files.length>0}}}return false};PwnFiler.prototype.initPipeline=function(b){var a=this.pipeline={};a.blockQ=new PwnFiler.BlockQueue(b.blockSize||1024*1024);a.readQ=new PwnFiler.TaskQueue(a.blockQ,PwnFiler.ReadQueue.create,b.readQueueSize||5);a.hashQ=new PwnFiler.TaskQueue(a.readQ,PwnFiler.TaskQueue.create,b.hashQueueSize||5);a.sendQ=new PwnFiler.SendQueue(a.sendQ,PwnFiler.UploadTask.create,1)};PwnFiler.BlockQueue=function(a){this.blockSize=a;this.files=[];this.currentFile=0;this.currentOffset=0};PwnFiler.BlockQueue.prototype.push=function(b){var a=sjcl.hash.sha256.hash(b.domFile.name);this.files.push({fileData:b,fileId:a})};PwnFiler.BlockQueue.prototype.empty=function(){return this.currentFile>this.files.length};PwnFiler.BlockQueue.prototype.pop=function(){if(this.empty()){return null}var b=this.files[this.currentFile];var d=b.fileData.domFile;var e=d.size-this.currentOffset;var c=Math.min(this.blockSize,e);var a=d;var f=this.currentOffset;if(d.slice){a=d.slice(f,c,d.type)}else{if(d.mozSlice){a=d.mozSlice(f,f+c,d.type)}else{if(d.webkitSlice){a=d.webkitSlice(f,f+c,d.type)}else{c=e;a=d}}}b.blob=a;b.start=f;this.currentOffset+=c;if(d.size<=this.currentOffset){this.currentOffset=0;this.currentFile+=1}return b};PwnFiler.BlockQueue.prototype.wantData=function(){if(!this.empty()){this.onData()}};PwnFiler.BlockQueue.prototype.onData=function(){};PwnFiler.ReadTask=function(c,d){this.blobData=c;this.callback=d;var a=new FileReader();this.reader=a;var b=this;a.onloadend=function(f){if(f.target.readyState!==FileReader.DONE||this.blobData===null){return true}var e=b.blobData;b.blobData=null;e.binaryData=f.target.result;b.callback(e)};a.readAsBinaryString(c.blob)};PwnFiler.ReadTask.create=function(a,b){return new PwnFiler.ReadTask(a,b)};PwnFiler.ReadTask.prototype.cancel=function(a){if(this.blobData===null){return}this.blobData=null;this.reader.abort()};PwnFiler.HashTask=function(a,b){this.blobData=a;this.callback=b;this.blobData.hashId=sjcl.hash.sha256.hash(this.blobData.binaryData);this.callback(this.blobData)};PwnFiler.HashTask.create=function(a,b){return new PwnFiler.HashTask(a,b)};PwnFiler.HashTask.prototype.cancel=function(){return};PwnFiler.UploadTask=function(b,e,d,a){this.blobData=d;this.finishCallback=a;var f=new XMLHttpRequest();this.xhr=f;var c=this;f.onprogress=function(g){};f.onloadend=function(h){if(h.target.readyState!==XMLHttpRequest.DONE||this.blobData===null){return true}var g=c.blobData;c.blobData=null;g.binaryData=h.target.result;c.finishCallback(g)};f.open("POST",b+"/"+d.hashId,true);f.setRequestHeader("X-Filer-Start",d.start);f.setRequestHeader("X-Filer-ID",d.fileId);f.setRequestHeader("Content-Type",d.blob.mimeType);f.send(d.binaryData)};PwnFiler.UploadTask.create=function(a,b){return function(c,d){return new PwnFiler.UploadTask(a,b,c,d)}};PwnFiler.UploadTask.prototype.cancel=function(a){if(this.blobData===null){return}this.blobData=null;this.xhr.abort()};PwnFiler.TaskQueue=function(c,b,d){this.pool=[];this.poolSize=d||1;this.pendingTask=null;this.pendingTaskData=null;this.source=c;this.createTask=b;var a=this;this.unboundOnTaskFinish=function(e){this.onTaskFinish(e)};this.unboundOnSourceData=function(){a.onSourceData()};if(this.source){this.source.onData=this.unboundOnSourceData}};PwnFiler.TaskQueue.prototype.empty=function(){return this.pool.length===0};PwnFiler.TaskQueue.prototype.full=function(){return this.pool.length>=this.poolSize};PwnFiler.TaskQueue.prototype.pop=function(){var a=this.empty()?null:this.pool.pop();if(!this.full()){this.source.wantData()}return a};PwnFiler.TaskQueue.prototype.onSourceData=function(){if(this.pendingTask||this.full()){return}this.pendingTaskData=this.source.pop();this.pendingTask=this.createTask(this.pendingTaskData,this.unboundOnTaskFinish)};PwnFiler.TaskQueue.prototype.unboundOnSourceData=null;PwnFiler.TaskQueue.prototype.onTaskFinish=function(a){this.pendingTask=null;this.pendingTaskData=null;this.pool.push(a);if(!this.full()){this.source.wantData()}this.onData()};PwnFiler.TaskQueue.prototype.unboundOnTaskFinish=null;PwnFiler.TaskQueue.prototype.onData=function(){};PwnFiler.TaskQueue.prototype.wantData=function(){if(!this.empty()){this.onData();return}if(!this.pendingOp&&!this.full()){this.source.wantData()}};PwnFiler.prototype.initSelection=function(b,a){this.selection=[];this.selectionDom=b;this.commitButton=a;if(this.commitButton){this.commitButton.setAttribute("disabled","disabled");var c=this;this.commitButton.addEventListener("click",function(d){return c.onCommitClick(d)})}};PwnFiler.prototype.onFileSelect=function(b){if(this.multiple){for(var a=0;a<b.length;a+=1){this.addFile(b[a])}}else{if(this.selection.length>0){this.removeFile(this.selection[0])}this.addFile(b[0])}if(!this.multiple){this.commitUpload()}};PwnFiler.prototype.selection=null;PwnFiler.prototype.selectionDom=null;PwnFiler.prototype.addFile=function(b){var a={domFile:b};this.selection.push(a);this.selectionDom.appendChild(this.buildFileSelectionDom(a));if(this.commitButton){this.commitButton.removeAttribute("disabled")}};PwnFiler.prototype.removeFile=function(b){var a=0;for(;a<this.selection.length;a+=1){if(this.selection[a]===b){break}}this.selection.splice(a,1);this.selectionDom.removeChild(b.selectionDom);if(this.commitButton&&this.selection.length===0){this.commitButton.setAttribute("disabled","disabled")}};PwnFiler.prototype.buildFileSelectionDom=function(c){var g=document.createElement("span");g.className="name";g.appendChild(document.createTextNode(c.domFile.name));var e=document.createElement("span");e.className="size";var h="";var d=c.domFile.size;if(d<1024){h=""+d+" bytes"}else{if(d<1024*1024){h=""+(d/1024).toFixed(2)+" kb"}else{if(d<1024*1024*1024){h=""+(d/(1024*1024)).toFixed(2)+" mb"}else{h=""+(d/(1024*1024*1024)).toFixed(2)+" gb"}}}e.appendChild(document.createTextNode(h));var b=document.createElement("progress");b.setAttribute("max",d);b.setAttribute("value",0);c.progressDom=b;var f=document.createElement("button");f.appendChild(document.createTextNode("Remove"));f.addEventListener("click",this.removeClickListener(c),false);var a=document.createElement("li");a.appendChild(g);a.appendChild(e);a.appendChild(b);a.appendChild(f);c.selectionDom=a;return a};PwnFiler.prototype.removeClickListener=function(a){var b=this;return function(c){b.removeFile(a);c.preventDefault();return false}};PwnFiler.prototype.onCommitClick=function(a){this.commitUpload();a.preventDefault();return false};PwnFiler.prototype.commitUpload=function(){};
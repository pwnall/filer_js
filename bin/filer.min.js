var PwnFiler=PwnFiler||function(a){a=a||{};this.multiple=a.multiple||false;if(a.uploadButton){var b=a.uploadButton;if(!(b instanceof Element)){b=document.querySelector(b)}this.initControl(b)}if(a.dropArea){var d=a.dropArea;if(!(d instanceof Element)){d=document.querySelector(d)}this.initDropArea(d,a.dropAreaActiveClass||"active")}var e=null;if(a.commitButton){e=a.commitButton;if(!(e instanceof Element)){e=document.querySelector(e)}}else{if(this.multiple){throw"No commit button provided for multi-file uploader"}}if(a.selection){var c=a.selection;if(!(c instanceof Element)){c=document.querySelector(c)}this.initSelection(c,e)}else{throw"Missing file selection display"}this.initPipeline(a.blockUploadUrl,a.hasher||"sjcl.hash.sha256",a.pipeline||{});this.initWorkers(a.workerUrl)};PwnFiler.prototype.initControl=function(a){var b=document.createElement("input");b.setAttribute("type","file");if(this.multiple){b.setAttribute("multiple","multiple")}var d=b.style;d.display="block";d.position="absolute";d.width=d.height="0";d.zIndex="-1000";a.parentNode.insertBefore(b,a);var c=this;a.addEventListener("click",function(e){return c.onUploadClick(e)},false);b.addEventListener("change",function(e){return c.onFileInputChange(e)},false);this.fileInput=b};PwnFiler.prototype.onUploadClick=function(a){this.fileInput.click();a.preventDefault();return false};PwnFiler.prototype.onFileInputChange=function(c){var d=c.target;if(d.files.length===0){this.onFileSelect(null)}else{var b=[];for(var a=0;a<d.files.length;a+=1){b[a]=d.files[a]}this.onFileSelect(b)}return true};PwnFiler.HashTask=function(d,c,b,e){this.blobData=b;this.callback=e;this.hasher=c;var a=this;d.inWorker("PwnFiler.HashTask.hashData",{hasher:this.hasher,data:this.blobData.binaryData},function(f){if(a.blobData===null){return}a.blobData.hashId=f;a.callback(a.blobData)})};PwnFiler.HashTask.create=function(b,a){return function(c,d){return new PwnFiler.HashTask(b,a,c,d)}};PwnFiler.HashTask.prototype.cancel=function(){this.blobData=null};PwnFiler.HashTask.hashData=function(b){var a=PwnFiler.resolveName(b.hasher);return sjcl.codec.hex.fromBits(a.hash(b.data))};PwnFiler.prototype.initDropArea=function(b,a){var c=this;b.addEventListener("dragenter",function(d){return c.onDropAreaDragEnter(d)},false);b.addEventListener("dragover",this.onDropAreaDragOver,false);b.addEventListener("dragleave",function(d){return c.onDropAreaDragLeave(d)},false);b.addEventListener("drop",function(d){return c.onDropAreaDrop(d)},false);this.dropArea=b;this.dropActiveClass=a;this.dropAreaEnterCount=0};PwnFiler.prototype.onDropAreaDragEnter=function(b){var a=b.dataTransfer;if(PwnFiler.dataTransferHasFiles(a)){a.dropEffect="copy"}else{return true}if(this.dropAreaEnterCount===0){this.activateDropArea()}this.dropAreaEnterCount+=1;b.stopPropagation();b.preventDefault();return false};PwnFiler.prototype.onDropAreaDragLeave=function(a){if(!PwnFiler.dataTransferHasFiles(a.dataTransfer)){return true}this.dropAreaEnterCount-=1;if(this.dropAreaEnterCount===0){this.deactivateDropArea()}};PwnFiler.prototype.dropAreaEnterCount=0;PwnFiler.prototype.onDropAreaDragOver=function(b){var a=b.dataTransfer;if(PwnFiler.dataTransferHasFiles(a)){a.dropEffect="copy"}else{return true}b.stopPropagation();b.preventDefault();return false};PwnFiler.prototype.onDropAreaDrop=function(d){this.dropAreaEnterCount=0;this.deactivateDropArea();var a=d.dataTransfer;if(a.files.length!==0){var c=[];for(var b=0;b<a.files.length;b+=1){c[b]=a.files.item(b)}this.onFileSelect(c);a.dropEffect="copy"}d.stopPropagation();d.preventDefault();return false};PwnFiler.prototype.activateDropArea=function(){var b=this.dropArea;var a=this.dropActiveClass;if(b.className.split(/\s+/).indexOf(a)===-1){b.className+=" "+a}};PwnFiler.prototype.deactivateDropArea=function(){var b=this.dropArea;var a=this.dropActiveClass;b.className=b.className.split(/\s+/).filter(function(c){return c!==a}).join(" ")};PwnFiler.dataTransferHasFiles=function(a){if(a.types.contains){return a.types.contains("Files")}else{if(a.types.indexOf){return a.types.indexOf("Files")!==-1}else{if(a.files){return a.files.length>0}}}return false};PwnFiler.prototype.initPipeline=function(d,e,c){var b=this.pipeline={};b.blockQ=new PwnFiler.BlockQueue(PwnFiler.resolveName(e),c.blockSize||1024*1024);b.readQ=new PwnFiler.TaskQueue(b.blockQ,PwnFiler.ReadTask.create,c.readQueueSize||5);b.hashQ=new PwnFiler.TaskQueue(b.readQ,PwnFiler.HashTask.create(this,e),c.hashQueueSize||5);var f=this;var g=function(i,h){f.onPipelineProgress(i,h)};b.sendQ=new PwnFiler.TaskQueue(b.hashQ,PwnFiler.UploadTask.create(d,g),1);var a=PwnFiler.DrainTask.create([b.blockQ,b.readQ,b.hashQ,b.sendQ,b.drain]);b.drain=new PwnFiler.TaskQueue(b.sendQ,a,1)};PwnFiler.prototype.pipelineFiles=function(b){for(var a=0;a<b.length;a+=1){this.pipeline.blockQ.push(b[a])}this.pipeline.drain.wantData()};PwnFiler.prototype.onPipelineProgress=function(d,c){var b=d.start+c;var a=d.fileData.progressDom;a.setAttribute("value",b)};PwnFiler.prototype.onPipelineDrain=function(){};PwnFiler.DrainTask=function(a,b,c){this.done=false;this.allQueues=a;this.sourceQueue=b;this.callback=c;c(null)};PwnFiler.DrainTask.create=function(a){return function(b,c){return new PwnFiler.DrainTask(a,b,c)}};PwnFiler.DrainTask.prototype.done=false;PwnFiler.TaskQueue=function(c,b,d){this.pool=[];this.poolSize=d||1;this.pendingTask=null;this.pendingTaskData=null;this.source=c;this.createTask=b;var a=this;this.unboundOnTaskFinish=function(e){a.onTaskFinish(e)};this.unboundOnSourceData=function(){a.onSourceData()};if(this.source){this.source.onData=this.unboundOnSourceData}};PwnFiler.TaskQueue.prototype.empty=function(){return this.pool.length===0};PwnFiler.TaskQueue.prototype.full=function(){return this.pool.length>=this.poolSize};PwnFiler.TaskQueue.prototype.pop=function(){var a=this.empty()?null:this.pool.shift();if(!this.full()){this.source.wantData()}return a};PwnFiler.TaskQueue.prototype.onSourceData=function(){if(this.pendingTask||this.full()){return}this.pendingTaskData=this.source.pop();this.pendingTask=true;var a=this.createTask(this.pendingTaskData,this.unboundOnTaskFinish);if(this.pendingTask===true){this.pendingTask=a}};PwnFiler.TaskQueue.prototype.unboundOnSourceData=null;PwnFiler.TaskQueue.prototype.onTaskFinish=function(a){this.pendingTask=null;this.pendingTaskData=null;if(a!==null){this.pool.push(a)}if(!this.full()){this.source.wantData()}this.onData()};PwnFiler.TaskQueue.prototype.unboundOnTaskFinish=null;PwnFiler.TaskQueue.prototype.onData=function(){};PwnFiler.TaskQueue.prototype.wantData=function(){if(!this.empty()){this.onData();return}if(!this.pendingOp&&!this.full()){this.source.wantData()}};PwnFiler.BlockQueue=function(b,a){this.hasher=b;this.blockSize=a;this.files=[];this.currentFile=0;this.currentOffset=0};PwnFiler.BlockQueue.prototype.push=function(b){var a=sjcl.codec.hex.fromBits(this.hasher.hash(b.domFile.name));this.files.push({fileData:b,fileId:a})};PwnFiler.BlockQueue.prototype.empty=function(){return this.currentFile>=this.files.length};PwnFiler.BlockQueue.prototype.pop=function(){if(this.empty()){return null}var e=this.files[this.currentFile];var b={fileData:e.fileData,fileId:e.fileId};var d=b.fileData.domFile;var f=d.size-this.currentOffset;var c=Math.min(this.blockSize,f);var a=d;var g=this.currentOffset;if(d.slice){a=d.slice(g,c,d.type)}else{if(d.mozSlice){a=d.mozSlice(g,g+c,d.type)}else{if(d.webkitSlice){a=d.webkitSlice(g,g+c,d.type)}else{c=f;a=d}}}b.blob=a;b.start=g;b.fileSize=d.size;this.currentOffset+=c;if(d.size<=this.currentOffset){b.last=true;this.currentOffset=0;this.currentFile+=1}else{b.last=false}return b};PwnFiler.BlockQueue.prototype.wantData=function(){if(!this.empty()){this.onData()}};PwnFiler.BlockQueue.prototype.onData=function(){};PwnFiler.ReadTask=function(c,d){this.blobData=c;this.callback=d;var a=new FileReader();this.reader=a;var b=this;a.onloadend=function(f){if(f.target.readyState!==FileReader.DONE||this.blobData===null){return true}var e=b.blobData;b.blobData=null;e.binaryData=f.target.result;b.callback(e)};a.readAsBinaryString(c.blob)};PwnFiler.ReadTask.create=function(a,b){return new PwnFiler.ReadTask(a,b)};PwnFiler.ReadTask.prototype.cancel=function(a){if(this.blobData===null){return}this.blobData=null;this.reader.abort()};PwnFiler.resolveName=function(b){var d=b.split(".");var a=self;for(var c=0;c<d.length;c+=1){a=a[d[c]]}return a};PwnFiler.prototype.initSelection=function(b,a){this.selection=[];this.selectionDom=b;this.commitButton=a;if(this.commitButton){this.commitButton.setAttribute("disabled","disabled");var c=this;this.commitButton.addEventListener("click",function(d){return c.onCommitClick(d)})}};PwnFiler.prototype.onFileSelect=function(b){if(this.multiple){for(var a=0;a<b.length;a+=1){this.addFile(b[a])}}else{if(this.selection.length>0){this.removeFile(this.selection[0])}this.addFile(b[0])}if(!this.multiple){this.commitUpload()}};PwnFiler.prototype.selection=null;PwnFiler.prototype.selectionDom=null;PwnFiler.prototype.addFile=function(b){var a={domFile:b};this.selection.push(a);this.selectionDom.appendChild(this.buildFileSelectionDom(a));if(this.commitButton){this.commitButton.removeAttribute("disabled")}};PwnFiler.prototype.removeFile=function(b){var a=0;for(;a<this.selection.length;a+=1){if(this.selection[a]===b){break}}this.selection.splice(a,1);this.selectionDom.removeChild(b.selectionDom);if(this.commitButton&&this.selection.length===0){this.commitButton.setAttribute("disabled","disabled")}};PwnFiler.prototype.buildFileSelectionDom=function(c){var g=document.createElement("span");g.className="name";g.appendChild(document.createTextNode(c.domFile.name));var e=document.createElement("span");e.className="size";var h="";var d=c.domFile.size;if(d<1024){h=""+d+" bytes"}else{if(d<1024*1024){h=""+(d/1024).toFixed(2)+" kb"}else{if(d<1024*1024*1024){h=""+(d/(1024*1024)).toFixed(2)+" mb"}else{h=""+(d/(1024*1024*1024)).toFixed(2)+" gb"}}}e.appendChild(document.createTextNode(h));var b=document.createElement("progress");b.setAttribute("max",d);b.setAttribute("value",0);c.progressDom=b;var f=document.createElement("button");f.appendChild(document.createTextNode("Remove"));f.addEventListener("click",this.removeClickListener(c),false);var a=document.createElement("li");a.appendChild(g);a.appendChild(e);a.appendChild(b);a.appendChild(f);c.selectionDom=a;return a};PwnFiler.prototype.removeClickListener=function(a){var b=this;return function(c){b.removeFile(a);c.preventDefault();return false}};PwnFiler.prototype.onCommitClick=function(a){this.commitUpload();a.preventDefault();return false};PwnFiler.prototype.commitUpload=function(){this.pipelineFiles(this.selection)};PwnFiler.UploadTask=function(c,d,b,a){this.uploadUrl=c;this.blobData=b;this.progressCallback=d;this.finishCallback=a;this.checkChunk()};PwnFiler.UploadTask.prototype.checkChunk=function(){var d=new XMLHttpRequest();this.xhr=d;var a=this;var c=function(e){return a.onChunkLoadEnd(e)};d.onloadend=c;d.onerror=c;d.onload=c;var b=this.blobData;d.open("PUT",this.uploadUrl,true);d.setRequestHeader("X-PwnFiler-FileID",b.fileId);d.setRequestHeader("X-PwnFiler-Hash",b.hashId);d.setRequestHeader("X-PwnFiler-Start",b.start);d.setRequestHeader("Content-Type","application/json");d.send(JSON.stringify({fileSize:b.fileSize,mimeType:b.blob.type||"application/octet-stream"}))};PwnFiler.UploadTask.prototype.onChunkLoadEnd=function(b){if(b.target.readyState!==(XMLHttpRequest.DONE||4)||this.blobData===null){return true}if(b.target.status===200){var a=JSON.parse(b.target.response);if(a.present){this.onXhrCompletion()}else{this.uploadChunk()}return true}return true};PwnFiler.UploadTask.prototype.uploadChunk=function(){var d=new XMLHttpRequest();this.xhr=d;var a=this;d.upload.onprogress=function(e){if(e.loaded){a.progressCallback(a.blobData,e.loaded)}};var c=function(e){return a.onUploadLoadEnd(e)};d.onloadend=c;d.onerror=c;d.onload=c;var b=this.blobData;d.open("POST",this.uploadUrl,true);d.setRequestHeader("X-PwnFiler-FileID",b.fileId);d.setRequestHeader("X-PwnFiler-Hash",b.hashId);d.setRequestHeader("X-PwnFiler-Start",b.start);d.setRequestHeader("Content-Type","application/octet-stream");d.send(b.binaryData)};PwnFiler.UploadTask.prototype.onUploadLoadEnd=function(a){if(a.target.readyState!==(XMLHttpRequest.DONE||4)||this.blobData===null){return true}if(a.target.status===200){this.onXhrCompletion();return true}else{if(a.target.status===400){this.uploadChunk();return true}}return true};PwnFiler.UploadTask.prototype.onXhrCompletion=function(){var a=this.blobData;this.blobData=null;this.progressCallback(a,a.binaryData.length);this.finishCallback(a)};PwnFiler.UploadTask.create=function(a,b){return function(c,d){return new PwnFiler.UploadTask(a,b,c,d)}};PwnFiler.UploadTask.prototype.cancel=function(a){if(this.blobData===null){return}this.blobData=null;this.xhr.abort()};PwnFiler.prototype.initWorkers=function(a){var c=this.worker=a&&(new Worker(a));this.workerCallbacks={};this.nextCommandId=0;var b=this;if(c){c.onmessage=function(d){return b.onWorkerMessage(d)}}};PwnFiler.prototype.inWorker=function(c,b,e){var a=this.nextCommandId;this.nextCommandId+=1;this.workerCallbacks[a]=e;var d={id:a,fn:c,arg:b};if(this.worker){this.worker.postMessage(d)}else{PwnFiler.Worker.currentFiler=this;PwnFiler.Worker.onMessage({data:d})}};PwnFiler.prototype.onWorkerMessage=function(b){var c=b.data;var a=c.id;var d=this.workerCallbacks[a];delete this.workerCallbacks[a];d(c.result)};PwnFiler.Worker={};PwnFiler.Worker.onMessage=function(c){var d=c.data;var b=PwnFiler.resolveName(d.fn);var a=b(d.arg);PwnFiler.Worker.postMessage({id:d.id,result:a})};PwnFiler.Worker.postMessage=function(a){PwnFiler.Worker.currentFiler.onWorkerMessage({data:a})};PwnFiler.Worker.main=function(){};"use strict";var sjcl={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(a){this.toString=function(){return"CORRUPT: "+this.message};this.message=a},invalid:function(a){this.toString=function(){return"INVALID: "+this.message};this.message=a},bug:function(a){this.toString=function(){return"BUG: "+this.message};this.message=a},notReady:function(a){this.toString=function(){return"NOT READY: "+this.message};this.message=a}}};
sjcl.bitArray={bitSlice:function(a,b,c){a=sjcl.bitArray.h(a.slice(b/32),32-(b&31)).slice(1);return c===undefined?a:sjcl.bitArray.clamp(a,c-b)},extract:function(a,b,c){var d=Math.floor(-b-c&31);return((b+c-1^b)&-32?a[b/32|0]<<32-d^a[b/32+1|0]>>>d:a[b/32|0]>>>d)&(1<<c)-1},concat:function(a,b){if(a.length===0||b.length===0)return a.concat(b);var c=a[a.length-1],d=sjcl.bitArray.getPartial(c);return d===32?a.concat(b):sjcl.bitArray.h(b,d,c|0,a.slice(0,a.length-1))},bitLength:function(a){var b=a.length;
if(b===0)return 0;return(b-1)*32+sjcl.bitArray.getPartial(a[b-1])},clamp:function(a,b){if(a.length*32<b)return a;a=a.slice(0,Math.ceil(b/32));var c=a.length;b&=31;if(c>0&&b)a[c-1]=sjcl.bitArray.partial(b,a[c-1]&2147483648>>b-1,1);return a},partial:function(a,b,c){if(a===32)return b;return(c?b|0:b<<32-a)+a*0x10000000000},getPartial:function(a){return Math.round(a/0x10000000000)||32},equal:function(a,b){if(sjcl.bitArray.bitLength(a)!==sjcl.bitArray.bitLength(b))return false;var c=0,d;for(d=0;d<a.length;d++)c|=
a[d]^b[d];return c===0},h:function(a,b,c,d){var e;e=0;if(d===undefined)d=[];for(;b>=32;b-=32){d.push(c);c=0}if(b===0)return d.concat(a);for(e=0;e<a.length;e++){d.push(c|a[e]>>>b);c=a[e]<<32-b}e=a.length?a[a.length-1]:0;a=sjcl.bitArray.getPartial(e);d.push(sjcl.bitArray.partial(b+a&31,b+a>32?c:d.pop(),1));return d},k:function(a,b){return[a[0]^b[0],a[1]^b[1],a[2]^b[2],a[3]^b[3]]}};
sjcl.codec.utf8String={fromBits:function(a){var b="",c=sjcl.bitArray.bitLength(a),d,e;for(d=0;d<c/8;d++){if((d&3)===0)e=a[d/4];b+=String.fromCharCode(e>>>24);e<<=8}return decodeURIComponent(escape(b))},toBits:function(a){a=unescape(encodeURIComponent(a));var b=[],c,d=0;for(c=0;c<a.length;c++){d=d<<8|a.charCodeAt(c);if((c&3)===3){b.push(d);d=0}}c&3&&b.push(sjcl.bitArray.partial(8*(c&3),d));return b}};
sjcl.codec.hex={fromBits:function(a){var b="",c;for(c=0;c<a.length;c++)b+=((a[c]|0)+0xf00000000000).toString(16).substr(4);return b.substr(0,sjcl.bitArray.bitLength(a)/4)},toBits:function(a){var b,c=[],d;a=a.replace(/\s|0x/g,"");d=a.length;a+="00000000";for(b=0;b<a.length;b+=8)c.push(parseInt(a.substr(b,8),16)^0);return sjcl.bitArray.clamp(c,d*4)}};sjcl.hash.sha256=function(a){this.e[0]||this.j();if(a){this.c=a.c.slice(0);this.b=a.b.slice(0);this.a=a.a}else this.reset()};sjcl.hash.sha256.hash=function(a){return(new sjcl.hash.sha256).update(a).finalize()};
sjcl.hash.sha256.prototype={blockSize:512,reset:function(){this.c=this.f.slice(0);this.b=[];this.a=0;return this},update:function(a){if(typeof a==="string")a=sjcl.codec.utf8String.toBits(a);var b,c=this.b=sjcl.bitArray.concat(this.b,a);b=this.a;a=this.a=b+sjcl.bitArray.bitLength(a);for(b=512+b&-512;b<=a;b+=512)this.d(c.splice(0,16));return this},finalize:function(){var a,b=this.b,c=this.c;b=sjcl.bitArray.concat(b,[sjcl.bitArray.partial(1,1)]);for(a=b.length+2;a&15;a++)b.push(0);b.push(Math.floor(this.a/
4294967296));for(b.push(this.a|0);b.length;)this.d(b.splice(0,16));this.reset();return c},f:[],e:[],j:function(){function a(e){return(e-Math.floor(e))*0x100000000|0}var b=0,c=2,d;a:for(;b<64;c++){for(d=2;d*d<=c;d++)if(c%d===0)continue a;if(b<8)this.f[b]=a(Math.pow(c,0.5));this.e[b]=a(Math.pow(c,1/3));b++}},d:function(a){var b,c,d=a.slice(0),e=this.c,j=this.e,i=e[0],g=e[1],f=e[2],l=e[3],h=e[4],m=e[5],k=e[6],n=e[7];for(a=0;a<64;a++){if(a<16)b=d[a];else{b=d[a+1&15];c=d[a+14&15];b=d[a&15]=(b>>>7^b>>>18^
b>>>3^b<<25^b<<14)+(c>>>17^c>>>19^c>>>10^c<<15^c<<13)+d[a&15]+d[a+9&15]|0}b=b+n+(h>>>6^h>>>11^h>>>25^h<<26^h<<21^h<<7)+(k^h&(m^k))+j[a];n=k;k=m;m=h;h=l+b|0;l=f;f=g;g=i;i=b+(g&f^l&(g^f))+(g>>>2^g>>>13^g>>>22^g<<30^g<<19^g<<10)|0}e[0]=e[0]+i|0;e[1]=e[1]+g|0;e[2]=e[2]+f|0;e[3]=e[3]+l|0;e[4]=e[4]+h|0;e[5]=e[5]+m|0;e[6]=e[6]+k|0;e[7]=e[7]+n|0}};sjcl.hash.sha1=function(a){if(a){this.c=a.c.slice(0);this.b=a.b.slice(0);this.a=a.a}else this.reset()};sjcl.hash.sha1.hash=function(a){return(new sjcl.hash.sha1).update(a).finalize()};
sjcl.hash.sha1.prototype={blockSize:512,reset:function(){this.c=this.f.slice(0);this.b=[];this.a=0;return this},update:function(a){if(typeof a==="string")a=sjcl.codec.utf8String.toBits(a);var b,c=this.b=sjcl.bitArray.concat(this.b,a);b=this.a;a=this.a=b+sjcl.bitArray.bitLength(a);for(b=this.blockSize+b&-this.blockSize;b<=a;b+=this.blockSize)this.d(c.splice(0,16));return this},finalize:function(){var a,b=this.b,c=this.c;b=sjcl.bitArray.concat(b,[sjcl.bitArray.partial(1,1)]);for(a=b.length+2;a&15;a++)b.push(0);
b.push(Math.floor(this.a/0x100000000));for(b.push(this.a|0);b.length;)this.d(b.splice(0,16));this.reset();return c},f:[1732584193,4023233417,2562383102,271733878,3285377520],e:[1518500249,1859775393,2400959708,3395469782],i:function(a,b,c,d){if(a<=19)return b&c|~b&d;else if(a<=39)return b^c^d;else if(a<=59)return b&c|b&d|c&d;else if(a<=79)return b^c^d},g:function(a,b){return b<<a|b>>>32-a},d:function(a){var b,c,d,e,j,i,g=a.slice(0),f=this.c;c=f[0];d=f[1];e=f[2];j=f[3];i=f[4];for(a=0;a<=79;a++){if(a>=
16)g[a]=this.g(1,g[a-3]^g[a-8]^g[a-14]^g[a-16]);b=this.g(5,c)+this.i(a,d,e,j)+i+g[a]+this.e[Math.floor(a/20)]|0;i=j;j=e;e=this.g(30,d);d=c;c=b}f[0]=f[0]+c|0;f[1]=f[1]+d|0;f[2]=f[2]+e|0;f[3]=f[3]+j|0;f[4]=f[4]+i|0}};
